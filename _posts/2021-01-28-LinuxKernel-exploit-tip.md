---
layout: post
title: Linux Kernel compile & using qemu
subtitle: Linux Kernel exploit tip
tags: [Linux, Kernel]
---

```
$ sudo apt-get install qemu qemu-kvm debootstrap ncurses-dev
$ git clone https://github.com/torvalds/linux
$ git checkout f991af3daabaecff34684fd51fac80319d1baad1
```

커널 이미지 만들기는 커널을 [다운로드](http://kernel.org/) 받고 압축을 풀어서 커널 디렉토리로 이동한 후.

```
$ make defconfig
$ make kvmconfig
$ make menuconfig
```

make menuconfig를 하면 옵션을 선택할 수 있는 창들이 뜰 텐데 여기서

```
Kernel Hacking
    compile-time checks and compiler options
        compile the kernel with debug info (v)
```

이후 make 하면 파일 생성 완료! `arch/x86/boot/bzImage` 에 커널 파일 생성되고 최상위 디렉토리에 `vmlinux` 파일이 생성된걸 확인 할 수 있음.

```bash
#!/bin/bash
# Copyright 2016 syzkaller project authors. All rights reserved.
# Use of this source code is governed by Apache 2 LICENSE that can be found in the LICENSE file.

# create-image.sh creates a minimal Debian Linux image suitable for syzkaller.

set -eux

# Create a minimal Debian distribution in a directory.
DIR=chroot
RELEASE=stretch
PREINSTALL_PKGS=openssh-server,curl,tar,gcc,libc6-dev,time,strace,ltrace,sudo,less,psmisc,selinux-utils,policycoreutils,checkpolicy,selinux-policy-default,gdb,make,sysbench,git,vim,usbutils,tcpdump,systemtap
sudo rm -rf $DIR
mkdir -p $DIR
sudo debootstrap --include=$PREINSTALL_PKGS $RELEASE $DIR

# Set some defaults and enable promtless ssh to the machine for root.
sudo sed -i '/^root/ { s/:x:/::/ }' $DIR/etc/passwd
echo 'T0:23:respawn:/sbin/getty -L ttyS0 115200 vt100' | sudo tee -a $DIR/etc/inittab
printf '\nauto eth0\niface eth0 inet dhcp\n' | sudo tee -a $DIR/etc/network/interfaces
echo 'debugfs /sys/kernel/debug debugfs defaults 0 0' | sudo tee -a $DIR/etc/fstab
echo 'SELINUX=disabled' | sudo tee $DIR/etc/selinux/config
echo "kernel.printk = 7 4 1 3" | sudo tee -a $DIR/etc/sysctl.conf
echo 'debug.exception-trace = 0' | sudo tee -a $DIR/etc/sysctl.conf
echo "net.core.bpf_jit_enable = 1" | sudo tee -a $DIR/etc/sysctl.conf
echo "net.core.bpf_jit_harden = 2" | sudo tee -a $DIR/etc/sysctl.conf
echo "net.ipv4.ping_group_range = 0 65535" | sudo tee -a $DIR/etc/sysctl.conf
echo -en "127.0.0.1\tlocalhost\n" | sudo tee $DIR/etc/hosts
echo "nameserver 8.8.8.8" | sudo tee -a $DIR/etc/resolve.conf
echo "debugging-machine" | sudo tee $DIR/etc/hostname
ssh-keygen -f $RELEASE.id_rsa -t rsa -N ''
sudo mkdir -p $DIR/root/.ssh/
cat $RELEASE.id_rsa.pub | sudo tee $DIR/root/.ssh/authorized_keys

# Build a disk image
dd if=/dev/zero of=$RELEASE.img bs=1M seek=2047 count=1
sudo mkfs.ext4 -F $RELEASE.img
sudo mkdir -p /mnt/$DIR
sudo mount -o loop $RELEASE.img /mnt/$DIR
sudo cp -a $DIR/. /mnt/$DIR/.
sudo umount /mnt/$DIR
```

이미지 만들기는 syzkaller 참고 하자 [링크](https://github.com/google/syzkaller/blob/master/tools/create-image.sh) 이전에 하면서 이슈였던건 클론 사이트 문제였는데 흐음 .. 일단 이건 까보고 ㅇㅇ

```
$ qemu-system-x86_64 -kernel bzImage -append "root=/dev/sda rw console=ttyS0 console=tty0 debug" -hda stretch.img -net user,hostfwd=tcp::10021-:22 -net nic -nographic -m 2G -smp 1 -s -S

$ gdb -q ./vmlinux
(gdb) target remote localhost:1234
(gdb) <something ex bp>
(gdb) c

```

command 에서 -s 는 gdb 를 default 로 쓰되 tcp port 1234 으로 연결하겠다는 의미의 옵션이다.(-gdb tcp::1234) -S 옵션은 cpu 를 start 해줄때까지 멈춰있겠다는 의미이다. ssh 할땐 `ssh root@localhost -p 10021 -i stretch.id_rsa` 처럼 접근.

+) `m 4G -smp 2` ram 이랑 core 선언.